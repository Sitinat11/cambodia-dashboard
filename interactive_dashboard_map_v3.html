<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Province Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #main {
      display: flex;
      flex: 1;
    }

    #map {
      height: 100%;
      width: 70%;
    }

    #dashboard {
      width: 30%;
      padding: 15px;
      border-left: 1px solid #ccc;
      background-color: #f9f9f9;
      overflow-y: auto;
    }

    #bottom-panel {
      width: 100%;
      padding: 20px;
      background-color: #f0f0f0;
    }

    .province-label {
      font-size: 12px;
      color: black;
      text-align: center;
      font-weight: bold;
      pointer-events: none;
    }

    canvas {
      max-width: 100%;
    }

    .plant-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .plant-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .crop-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      margin-right: 8px;
    }

    .cassava { background-color: #28a745; }
    .corn { background-color: #ffc107; color: black; }

    .plant-dates {
      font-size: 14px;
      color: #333;
    }

    .date-icon {
      margin-right: 4px;
    }

    .top5-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      padding: 10px;
      background-color: #007acc;
      color: white;
      border-radius: 8px;
      text-align: center;
    }

    .top5-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: auto;
    }

    .crop-section {
      flex: 1 1 300px;
      padding: 10px;
      border-radius: 8px;
      background-color: #f4f4f4;
    }

    .crop-section h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      border-left: 5px solid;
      padding-left: 8px;
    }

    .crop-section.corn {
      border-color: #ffc107;
    }

    .crop-section.cassava {
      border-color: #28a745;
    }

    .harvest-bar-container {
      margin-bottom: 6px;
    }

    .harvest-bar-label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .harvest-bar-bg {
      background: #eee;
      height: 12px;
      border-radius: 4px;
      overflow: hidden;
    }

    .harvest-bar-fill {
      height: 100%;
    }
  </style>
</head>
<body>

<div id="main">
  <div id="map"></div>
  <div id="dashboard">
    <h1 style="text-align:center;">Cambodia Project</h1>
    <h2 id="province-title">Province: Click a province</h2>
    <p id="plant-range">Plant Date Range: </p>
    <canvas id="harvestChart"></canvas>
  </div>
</div>

<div id="bottom-panel">
  <div class="top5-header">Top 5 Provinces by Percent Harvested</div>
  <div id="top5-list"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    
Promise.all([
  fetch('provinces.geojson?v=' + Date.now()).then(res => res.json()),
  fetch('dashboard_data.json?v=' + Date.now()).then(res => res.json())
]).then(([geoData, chartData]) => {
    
  // âœ… Print version check and basic info
  console.log('âœ… Loaded provinces.geojson at:', new Date().toISOString());
  console.log('ðŸ“¦ Feature count:', geoData.features?.length || 0);
  console.log('ðŸ—‚ Example property:', geoData.features?.[0]?.properties);

  const map = L.map('map').setView([11.5, 105], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const provinceLookup = {};
  chartData.forEach(row => {
    if (!provinceLookup[row.Province]) provinceLookup[row.Province] = [];
    provinceLookup[row.Province].push(row);
  });

  let selectedLayer = null;

  function onEachFeature(feature, layer) {
    const name = feature.properties.Province || feature.properties.HRName || 'Unknown';
    layer.on('click', function () {
      if (selectedLayer) {
        selectedLayer.setStyle({ fillColor: "#cccccc" });
      }
      selectedLayer = layer;
      layer.setStyle({ fillColor: "#ffa500" });

      updateDashboard(name);
    });

    const center = layer.getBounds().getCenter();
    L.marker(center, {
      icon: L.divIcon({
        className: 'province-label',
        html: name,
        iconSize: [100, 20]
      })
    }).addTo(map);
  }

  L.geoJSON(geoData, {
    onEachFeature: onEachFeature,
    style: {
      color: "#333",
      weight: 1,
      fillOpacity: 0.4,
      fillColor: "#cccccc"
    }
  }).addTo(map);
  
  let ctx = document.getElementById('harvestChart').getContext('2d');
  let chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Percent Harvested',
        data: [],
        backgroundColor: '#007acc'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });

  function renderTop5List(chartData) {
    const allowedOrder = ['corn', 'cassava'];
    const cropGroups = {};

    chartData.forEach(row => {
      const cropKey = row.CropType ? row.CropType.toLowerCase() : '';
      if (allowedOrder.includes(cropKey) && row.Percent_Harvested != null) {
        const properName = cropKey.charAt(0).toUpperCase() + cropKey.slice(1);
        if (!cropGroups[properName]) cropGroups[properName] = [];
        cropGroups[properName].push(row);
      }
    });

    let html = `<div class="top5-container">`;

    allowedOrder.forEach(cropKey => {
      const cropNameProper = cropKey.charAt(0).toUpperCase() + cropKey.slice(1);
      if (cropGroups[cropNameProper]) {
        const barColor = cropKey === 'corn' ? '#ffc107' : '#28a745';

        html += `<div class="crop-section ${cropKey}"><h4>${cropNameProper}</h4>`;

        cropGroups[cropNameProper]
          .sort((a, b) => b.Percent_Harvested - a.Percent_Harvested)
          .slice(0, 5)
          .forEach(item => {
            const percent = item.Percent_Harvested;
            html += `
              <div class="harvest-bar-container">
                <div class="harvest-bar-label">${item.Province} (${percent.toFixed(1)}%)</div>
                <div class="harvest-bar-bg">
                  <div class="harvest-bar-fill" style="width:${percent}%; background-color:${barColor};"></div>
                </div>
              </div>`;
          });

        html += `</div>`;
      }
    });

    html += `</div>`;
    document.getElementById("top5-list").innerHTML = html;
  }

  function updateDashboard(province) {
    const data = provinceLookup[province];
    if (!data) return;

    document.getElementById("province-title").innerText = `Province: ${province}`;

    if (!data || data.length === 0) {
      document.getElementById("plant-range").innerHTML = `<strong>Plant Date Range:</strong><br><em>No data available</em>`;
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
      return;
    }

    const plantRangeText = data.map(d => {
      if (!d.Plantdate_range || !d.CropType) return '';

      let cropClass = '';
      const cropType = d.CropType.toLowerCase();
      if (cropType === 'cassava') cropClass = 'cassava';
      if (cropType === 'corn') cropClass = 'corn';

      const [startDate, endDate] = d.Plantdate_range.split(' to ');

      return `
        <div class="plant-card">
          <div class="plant-header">
            <span class="crop-badge ${cropClass}">${d.CropType}</span>
          </div>
          <div class="plant-dates">
            <span class="date-icon">ðŸ“…</span> during ${startDate} to ${endDate}
          </div>
        </div>`;
    }).filter(card => card !== '').join('');

    document.getElementById("plant-range").innerHTML = `<strong>Plant Date Range:</strong><br>${plantRangeText || '<em>No planting data</em>'}`;

    const chartLabels = data.map(d => d.CropType || 'Unknown');
    const chartValues = data.map(d => d.Percent_Harvested != null ? d.Percent_Harvested : 0);

    chart.data.labels = chartLabels;
    chart.data.datasets[0].data = chartValues;
    chart.update();
  }

  renderTop5List(chartData);

});
</script>
</body>
</html>